# AKS Terraform Foundation

A production-ready Azure Kubernetes Service (AKS) infrastructure with Crossplane, ArgoCD, and Vault, managed entirely with Terraform.

## ğŸš€ Quick Start

```bash
# Clone and navigate to the project
cd 01-aks-tf

# Initialize and deploy
make init ENV=dev
make plan
make apply

# Get AKS credentials
az aks get-credentials --name aks-test --resource-group aks-test-rg
```

For detailed setup instructions, see the [Quickstart Guide](docs/setup/quickstart.md).

## ğŸ“‹ Table of Contents

- [Features](#features)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Documentation](#documentation)
- [Project Structure](#project-structure)
- [Quick Reference](#quick-reference)
- [Contributing](#contributing)
- [License](#license)

## âœ¨ Features

### Infrastructure
- **Azure Kubernetes Service (AKS)**: Production-ready Kubernetes cluster
- **Multi-environment Support**: Separate workspaces for dev and production
- **Infrastructure as Code**: Complete Terraform configuration
- **Azure Integration**: Workload Identity, Azure CNI, managed identities

### Platform Services
- **ArgoCD**: GitOps continuous delivery
  - Public endpoint with Azure Public IP
  - DNS: `luciano-argocd.eastus.cloudapp.azure.com`
- **Crossplane**: Cloud-native control plane
  - Azure Workload Identity integration
  - Provider family for Azure resources
- **Vault**: Secrets management (HashiCorp Vault)

### Operations
- **Makefile Commands**: Simplified infrastructure management
- **Terraform Workspaces**: Environment isolation
- **Namespaced Resources**: Organized by system component
- **Logging & Monitoring**: Azure Log Analytics integration

## ğŸ—ï¸ Architecture

This project implements a modern cloud-native platform on Azure:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Azure Cloud                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    AKS Cluster                             â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚   ArgoCD     â”‚  â”‚  Crossplane  â”‚  â”‚    Vault     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ devops-systemâ”‚  â”‚resources-sys â”‚  â”‚ devops-systemâ”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚              Application Namespaces                  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  gateway â€¢ observability â€¢ pipeline â€¢ security      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Public IP   â”‚  â”‚  Managed Identityâ”‚  â”‚  Log Analytics  â”‚  â”‚
â”‚  â”‚   (ArgoCD)    â”‚  â”‚   (Crossplane)   â”‚  â”‚   Workspace     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

For detailed architecture documentation, see:
- [Crossplane Azure Workload Identity](docs/architecture/crossplane-azure-workload-identity.md)
- [Crossplane Implementation Summary](docs/architecture/crossplane-implementation-summary.md)

## ğŸ“¦ Prerequisites

- **Azure CLI**: Authenticated with appropriate subscription
- **Terraform**: >= 1.0
- **kubectl**: For Kubernetes cluster management
- **make**: For using Makefile commands
- **Azure Subscription**: With contributor permissions

### Required Environment Variables

```bash
export ARM_SUBSCRIPTION_ID="your-subscription-id"
```

## ğŸ“š Documentation

### Setup & Getting Started
- [**Quickstart Guide**](docs/setup/quickstart.md) - Get up and running in minutes
- [**Makefile Reference**](docs/reference/makefile.md) - All available Make commands

### Guides
- [**ArgoCD Public Endpoint**](docs/guides/argocd-public-endpoint.md) - Expose ArgoCD publicly
- [**Namespace Update**](docs/guides/namespace-update.md) - Managing Kubernetes namespaces

### Architecture & Design
- [**Crossplane Azure Workload Identity**](docs/architecture/crossplane-azure-workload-identity.md)
- [**Crossplane Implementation Summary**](docs/architecture/crossplane-implementation-summary.md)

### Reference
- [**Crossplane README**](docs/reference/crossplane-readme.md) - Crossplane configuration details
- [**AKS Foundation README**](aks-foundation/README.md) - Terraform module documentation

## ğŸ“ Project Structure

```
01-aks-tf/
â”œâ”€â”€ README.md                      # This file
â”œâ”€â”€ makefile                       # Infrastructure management commands
â”œâ”€â”€ docs/                          # Documentation
â”‚   â”œâ”€â”€ setup/                     # Setup and installation guides
â”‚   â”‚   â””â”€â”€ quickstart.md
â”‚   â”œâ”€â”€ guides/                    # How-to guides
â”‚   â”‚   â”œâ”€â”€ argocd-public-endpoint.md
â”‚   â”‚   â””â”€â”€ namespace-update.md
â”‚   â”œâ”€â”€ architecture/              # Architecture documentation
â”‚   â”‚   â”œâ”€â”€ crossplane-azure-workload-identity.md
â”‚   â”‚   â””â”€â”€ crossplane-implementation-summary.md
â”‚   â””â”€â”€ reference/                 # Reference documentation
â”‚       â”œâ”€â”€ makefile.md
â”‚       â””â”€â”€ crossplane-readme.md
â”œâ”€â”€ aks-foundation/                # Terraform configuration
â”‚   â”œâ”€â”€ main.tf                    # Main AKS cluster configuration
â”‚   â”œâ”€â”€ variables.tf               # Input variables
â”‚   â”œâ”€â”€ outputs.tf                 # Output values
â”‚   â”œâ”€â”€ aks_addons_argocd.tf      # ArgoCD Helm installation
â”‚   â”œâ”€â”€ aks_cluster_namespaces.tf # Kubernetes namespaces
â”‚   â”œâ”€â”€ argocd_public_ingress.tf  # ArgoCD public endpoint
â”‚   â”œâ”€â”€ crossplane_*.tf           # Crossplane configuration
â”‚   â”œâ”€â”€ vault.tf                   # Vault installation
â”‚   â””â”€â”€ ...                        # Additional configuration files
â”œâ”€â”€ import-existing-cluster.sh     # Script to import existing cluster
â””â”€â”€ verify-namespace-update.sh     # Namespace verification script
```

## âš¡ Quick Reference

### Common Commands

```bash
# Initialize for dev environment
make init

# Plan changes
make plan

# Apply changes
make apply

# Full upgrade cycle
make upgrade

# Switch to production
make init ENV=prd

# Destroy infrastructure (âš ï¸ careful!)
make destroy
```

### Access Services

```bash
# ArgoCD
URL: http://luciano-argocd.eastus.cloudapp.azure.com
Username: admin
Password: kubectl -n devops-system get secret argocd-initial-admin-secret \
  -o jsonpath="{.data.password}" | base64 -d

# Get AKS credentials
az aks get-credentials --name aks-test --resource-group aks-test-rg

# Check cluster status
kubectl get nodes
kubectl get pods -A
```

### Terraform Outputs

```bash
# View all outputs
terraform -chdir=./aks-foundation output

# Specific outputs
terraform -chdir=./aks-foundation output argocd_public_fqdn
terraform -chdir=./aks-foundation output crossplane_identity_client_id
terraform -chdir=./aks-foundation output aks_name
```

## ğŸ”§ Configuration

### Customize Variables

Edit `aks-foundation/terraform.tfvars` or create your own:

```hcl
# Environment
location = "eastus"
resource_group_name = "aks-test-rg"

# AKS Configuration
kubernetes_version = "1.34"
agents_count = 3
agents_size = "Standard_D4s_v3"

# Crossplane
crossplane_version = "1.18.4"
crossplane_provider_family_azure_version = "v2.3.0"

# ArgoCD
# Configured via Helm values in aks_addons_argocd.tf
```

## ğŸ› ï¸ Development

### Local Development

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd 01-aks-tf
   ```

2. **Set up Azure authentication**
   ```bash
   az login
   export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
   ```

3. **Initialize Terraform**
   ```bash
   make init ENV=dev
   ```

4. **Make changes and test**
   ```bash
   make plan
   # Review changes
   make apply
   ```

### Testing Changes

```bash
# Validate Terraform configuration
terraform -chdir=./aks-foundation validate

# Format Terraform files
terraform -chdir=./aks-foundation fmt -recursive

# Check for issues with checkov
checkov -d aks-foundation/
```

## ğŸ” Security Considerations

- **Workload Identity**: Crossplane uses Azure Workload Identity (no secrets in cluster)
- **RBAC**: Kubernetes RBAC enabled with Azure AD integration
- **Network Policies**: Configure as needed for your security requirements
- **Secrets Management**: Vault for application secrets
- **Public Endpoints**: ArgoCD exposed publicly - consider adding authentication/TLS

For production:
1. Enable TLS for ArgoCD
2. Configure network security groups
3. Implement Azure Firewall or Application Gateway
4. Enable Azure Policy for AKS
5. Configure backup and disaster recovery

## ğŸ“– Additional Resources

- [Azure AKS Documentation](https://docs.microsoft.com/en-us/azure/aks/)
- [Crossplane Documentation](https://docs.crossplane.io/)
- [ArgoCD Documentation](https://argo-cd.readthedocs.io/)
- [Terraform AzureRM Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## ğŸ“ License

This project is licensed under the MIT License - see the LICENSE file for details.

## ğŸ‘¥ Authors

- Luciano Silva

## ğŸ™ Acknowledgments

- Azure AKS team for excellent Kubernetes service
- Crossplane community for cloud-native infrastructure management
- ArgoCD community for GitOps excellence
- Terraform community for infrastructure as code

---

**Note**: This is a reference implementation. Customize according to your organization's requirements and security policies.
